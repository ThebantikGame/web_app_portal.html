import telebot
from telebot import types
import sqlite3
import time
import re
import urllib.parse

# --- –ö–û–ù–§–ò–ì–£–†–ê–¶–ò–Ø –ë–û–¢–ê ---
TOKEN = '8258635825:AAHRJpE2Mu2Qncm1sszladyjip6bXQRlo6o'
bot = telebot.TeleBot(TOKEN)
DB_NAME = 'dzi_database.db'
WEB_APP_URL = 'https://thebantikgame.github.io/web_app_portal.html'  # ‚Üê –±–µ–∑ –ø—Ä–æ–±–µ–ª–æ–≤ –≤ –∫–æ–Ω—Ü–µ!

# --- –ö–ê–¢–ï–ì–û–†–ò–ò (—Å—Ñ–µ—Ä—ã –¥–µ—è—Ç–µ–ª—å–Ω–æ—Å—Ç–∏) ---
DZI_DATABASE = {
    "–ú–µ–¥–∏—Ü–∏–Ω–∞": {
        "emoji_button": "üè• –ú–µ–¥–∏—Ü–∏–Ω–∞",
        "name": "–î–∑–∏ 3 –ì–ª–∞–∑–∞ (–£–¥–∞—á–Ω–∞—è –ö–∞—Ä—å–µ—Ä–∞)",
        "description": "–ë—É—Å–∏–Ω–∞ —Å–∏–º–≤–æ–ª–∏–∑–∏—Ä—É–µ—Ç –±–æ–≥–∞—Ç—Å—Ç–≤–æ, —É—Å–ø–µ—Ö –∏ –¥–æ–ª–≥–æ–ª–µ—Ç–∏–µ. –î–ª—è —Å—Ñ–µ—Ä—ã –º–µ–¥–∏—Ü–∏–Ω—ã –æ–Ω–∞ –ø—Ä–∏–Ω–æ—Å–∏—Ç —É–¥–∞—á—É –≤ –ª–µ—á–µ–Ω–∏–∏, —Å—Ç–∞–±–∏–ª—å–Ω–æ—Å—Ç—å –∏ –ø—Ä–∏–∑–Ω–∞–Ω–∏–µ. –£–∫—Ä–µ–ø–ª—è–µ—Ç –∏–Ω—Ç—É–∏—Ü–∏—é –∏ —Å–ø–æ–∫–æ–π—Å—Ç–≤–∏–µ –ø—Ä–∏ —Ä–∞–±–æ—Ç–µ —Å –ø–∞—Ü–∏–µ–Ω—Ç–∞–º–∏.",
        "image_url": "https://placehold.co/400x400/8A2BE2/ffffff?text=3+Eyes+Dzi"
    },
    "–ë–∏–∑–Ω–µ—Å": {
        "emoji_button": "üíº –ë–∏–∑–Ω–µ—Å",
        "name": "–î–∑–∏ 21 –ì–ª–∞–∑ (–ò—Å–ø–æ–ª–Ω–µ–Ω–∏–µ –ñ–µ–ª–∞–Ω–∏–π)",
        "description": "–ú–æ—â–Ω–µ–π—à–∏–π —Ç–∞–ª–∏—Å–º–∞–Ω, –∏—Å–ø–æ–ª–Ω—è—é—â–∏–π –∂–µ–ª–∞–Ω–∏—è –∏ –≤–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞—é—â–∏–π —ç–Ω–µ—Ä–≥–∏—é. –ù–µ–∑–∞–º–µ–Ω–∏–º –≤ –±–∏–∑–Ω–µ—Å–µ: –ø—Ä–∏–≤–ª–µ–∫–∞–µ—Ç –∫–∞–ø–∏—Ç–∞–ª, –ø–æ–º–æ–≥–∞–µ—Ç –≤ –ø–µ—Ä–µ–≥–æ–≤–æ—Ä–∞—Ö –∏ —Å—Ç—Ä–∞—Ç–µ–≥–∏—á–µ—Å–∫–æ–º –ø–ª–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏–∏.",
        "image_url": "https://placehold.co/400x400/FFD700/000000?text=21+Eyes+Dzi"
    },
    "–û–±—Ä–∞–∑–æ–≤–∞–Ω–∏–µ": {
        "emoji_button": "üéì –û–±—Ä–∞–∑–æ–≤–∞–Ω–∏–µ",
        "name": "–î–∑–∏ 5 –õ–µ—Ç—É—á–∏—Ö –ú—ã—à–µ–π (–£–¥–∞—á–∞ –∏ –ü—Ä–æ—Ü–≤–µ—Ç–∞–Ω–∏–µ)",
        "description": "–ü—Ä–∏–≤–ª–µ–∫–∞–µ—Ç –ø—è—Ç—å –≤–∏–¥–æ–≤ —É–¥–∞—á–∏ –∏ –∑–∞—â–∏—Ç—É –æ—Ç –Ω–µ—É–¥–∞—á. –ò–¥–µ–∞–ª–µ–Ω –¥–ª—è —Å—Ñ–µ—Ä—ã –æ–±—Ä–∞–∑–æ–≤–∞–Ω–∏—è: —É—Å–∏–ª–∏–≤–∞–µ—Ç –∞–≤—Ç–æ—Ä–∏—Ç–µ—Ç, –¥–∞—Ä—É–µ—Ç —Ç–µ—Ä–ø–µ–Ω–∏–µ –ø—Ä–∏ —Ä–∞–±–æ—Ç–µ —Å —É—á–µ–Ω–∏–∫–∞–º–∏ –∏ –ø–æ–º–æ–≥–∞–µ—Ç –≤ –ø–µ—Ä–µ–¥–∞—á–µ –∑–Ω–∞–Ω–∏–π.",
        "image_url": "https://placehold.co/400x400/F08080/ffffff?text=5+Bats+Dzi"
    },
    "IT": {
        "emoji_button": "üñ•Ô∏è IT",
        "name": "–î–∑–∏ –ó—É–± –¢–∏–≥—Ä–∞ (–°–∏–ª–∞ –∏ –£—Å—Ç—Ä–∞–Ω–µ–Ω–∏–µ –ü—Ä–µ–ø—è—Ç—Å—Ç–≤–∏–π)",
        "description": "–î–∞–µ—Ç –Ω–µ—Å–≥–∏–±–∞–µ–º—É—é —Å–∏–ª—É –¥—É—Ö–∞, –∫–æ–Ω—Ü–µ–Ω—Ç—Ä–∞—Ü–∏—é –∏ —Å–ø–æ—Å–æ–±–Ω–æ—Å—Ç—å —É—Å—Ç—Ä–∞–Ω—è—Ç—å –ª—é–±—ã–µ —Ç–µ—Ö–Ω–∏—á–µ—Å–∫–∏–µ –∏–ª–∏ –º–µ–Ω—Ç–∞–ª—å–Ω—ã–µ –ø—Ä–µ–ø—è—Ç—Å—Ç–≤–∏—è. –£—Å–∏–ª–∏–≤–∞–µ—Ç –ª–æ–≥–∏–∫—É –∏ –∞–Ω–∞–ª–∏—Ç–∏—á–µ—Å–∫–∏–µ —Å–ø–æ—Å–æ–±–Ω–æ—Å—Ç–∏ –≤ IT-–ø—Ä–æ–µ–∫—Ç–∞—Ö.",
        "image_url": "https://placehold.co/400x400/4682B4/ffffff?text=Tiger+Tooth+Dzi"
    },
    "–¢–≤–æ—Ä—á–µ—Å—Ç–≤–æ": {
        "emoji_button": "üé≠ –¢–≤–æ—Ä—á–µ—Å—Ç–≤–æ",
        "name": "–î–∑–∏ –õ–æ—Ç–æ—Å (–ß–∏—Å—Ç–æ—Ç–∞ –∏ –ì–∞—Ä–º–æ–Ω–∏—è)",
        "description": "–û—á–∏—â–∞–µ—Ç —É–º, –¥–∞—Ä—É–µ—Ç –≥–∞—Ä–º–æ–Ω–∏—é, —è—Å–Ω–æ—Å—Ç—å –º—ã—à–ª–µ–Ω–∏—è –∏ –≤–¥–æ—Ö–Ω–æ–≤–µ–Ω–∏–µ. –ò–¥–µ–∞–ª–µ–Ω –¥–ª—è —Ç–≤–æ—Ä—á–µ—Å–∫–∏—Ö –ø—Ä–æ—Ñ–µ—Å—Å–∏–π: –¥–∏–∑–∞–π–Ω–µ—Ä–æ–≤, —Ö—É–¥–æ–∂–Ω–∏–∫–æ–≤, –º—É–∑—ã–∫–∞–Ω—Ç–æ–≤ ‚Äî –ø–æ–º–æ–≥–∞–µ—Ç –Ω–∞—Ö–æ–¥–∏—Ç—å –Ω–æ–≤—ã–µ –∏–¥–µ–∏.",
        "image_url": "https://placehold.co/400x400/3CB371/ffffff?text=Lotus+Dzi"
    },
    "–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ": {
        "emoji_button": "üìä –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ",
        "name": "–î–∑–∏ –ì–æ—Ä–∞ (–°—Ç–∞–±–∏–ª—å–Ω–æ—Å—Ç—å –∏ –õ–∏–¥–µ—Ä—Å—Ç–≤–æ)",
        "description": "–î–∞—Ä—É–µ—Ç —Å—Ç–∞–±–∏–ª—å–Ω–æ—Å—Ç—å, –Ω–µ–ø–æ–∫–æ–ª–µ–±–∏–º–æ—Å—Ç—å –∏ –ª–∏–¥–µ—Ä—Å–∫–∏–µ –∫–∞—á–µ—Å—Ç–≤–∞. –ü–æ–º–æ–≥–∞–µ—Ç –≤ —É–ø—Ä–∞–≤–ª–µ–Ω–∏–∏ –∫–æ–º–∞–Ω–¥–∞–º–∏, –ø—Ä–∏–Ω—è—Ç–∏–∏ —Ä–µ—à–µ–Ω–∏–π –∏ —Å—Ç—Ä–∞—Ç–µ–≥–∏—á–µ—Å–∫–æ–º –ø–ª–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏–∏.",
        "image_url": "https://placehold.co/400x400/A9A9A9/000000?text=Mountain+Dzi"
    }
}

CATEGORY_OPTIONS = list(DZI_DATABASE.keys())

# --- –£–¢–ò–õ–ò–¢–´ ---
def safe_text_for_markdown(text):
    return re.sub(r'([_*\[\]()`])', r'\\\1', text)

def initialize_db():
    conn = sqlite3.connect(DB_NAME)
    cursor = conn.cursor()
    cursor.execute("""
        CREATE TABLE IF NOT EXISTS Users (
            user_id INTEGER PRIMARY KEY,
            username TEXT,
            last_result_name TEXT,
            last_reveal_timestamp INTEGER
        )
    """)
    conn.commit()
    conn.close()
    print("‚úÖ –ë–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω–∞.")

def update_user_result(user_id, username, result_name):
    conn = sqlite3.connect(DB_NAME)
    cursor = conn.cursor()
    cursor.execute("""
        REPLACE INTO Users (user_id, username, last_result_name, last_reveal_timestamp)
        VALUES (?, ?, ?, ?)
    """, (user_id, username, result_name, int(time.time())))
    conn.commit()
    conn.close()

def get_last_timestamp(user_id):
    conn = sqlite3.connect(DB_NAME)
    cursor = conn.cursor()
    cursor.execute("SELECT last_reveal_timestamp FROM Users WHERE user_id = ?", (user_id,))
    result = cursor.fetchone()
    conn.close()
    return result[0] if result else None

# --- –û–ë–†–ê–ë–û–¢–ß–ò–ö–ò ---
@bot.message_handler(commands=['start'])
def send_welcome(message):
    user_id = message.from_user.id
    username = message.from_user.username or "–î—Ä—É–≥"
    safe_name = safe_text_for_markdown(username)
    text = f"üåü –ü—Ä–∏–≤–µ—Ç—Å—Ç–≤—É—é, {safe_name}, –≤ –ü–æ—Ä—Ç–∞–ª–µ –¢–∞–ª–∏—Å–º–∞–Ω–æ–≤ –î–∑–∏! üåü\n\n–í—ã–±–µ—Ä–∏—Ç–µ —Å—Ñ–µ—Ä—É:"
    
    markup = types.InlineKeyboardMarkup()
    markup.add(types.InlineKeyboardButton("üîÆ –í—ã–±—Ä–∞—Ç—å —Å—Ñ–µ—Ä—É", callback_data='ACTION_SELECT_CATEGORY'))
    bot.send_message(user_id, text, parse_mode="Markdown", reply_markup=markup)

@bot.callback_query_handler(func=lambda call: call.data == 'ACTION_SELECT_CATEGORY')
def ask_for_category(call):
    user_id = call.from_user.id
    last_ts = get_last_timestamp(user_id)
    if last_ts and time.time() - last_ts < 30:
        rem = int(30 - (time.time() - last_ts))
        markup = types.InlineKeyboardMarkup()
        markup.add(types.InlineKeyboardButton("‚¨ÖÔ∏è –ù–∞–∑–∞–¥", callback_data='ACTION_MENU'))
        bot.edit_message_text(
            "‚è≥ –ü–æ–¥–æ–∂–¥–∏—Ç–µ –µ—â—ë {} —Å–µ–∫.".format(rem),
            call.message.chat.id, call.message.message_id,
            reply_markup=markup
        )
        return

    markup = types.InlineKeyboardMarkup(row_width=2)
    for cat in CATEGORY_OPTIONS:
        markup.add(types.InlineKeyboardButton(DZI_DATABASE[cat]["emoji_button"], callback_data=f'CATEGORY_{cat}'))
    markup.add(types.InlineKeyboardButton("‚¨ÖÔ∏è –ù–∞–∑–∞–¥", callback_data='ACTION_MENU'))
    
    bot.edit_message_text(
        "–í—ã–±–µ—Ä–∏—Ç–µ —Å—Ñ–µ—Ä—É:",
        call.message.chat.id, call.message.message_id,
        reply_markup=markup
    )

@bot.callback_query_handler(func=lambda call: call.data.startswith('CATEGORY_'))
def reveal_dzi(call):
    category = call.data.split('_', 1)[1]
    dzi_data = DZI_DATABASE.get(category)
    if not dzi_data:
        bot.answer_callback_query(call.id, "‚ùå –ù–µ –Ω–∞–π–¥–µ–Ω–æ")
        return

    # –°–æ—Ö—Ä–∞–Ω—è–µ–º –≤—ã–±–æ—Ä
    user_id = call.from_user.id
    username = call.from_user.username or str(user_id)
    update_user_result(user_id, username, dzi_data["name"])

    # –§–æ—Ä–º–∏—Ä—É–µ–º URL –¥–ª—è Web App
    params = {
        'prof': category,
        'name': dzi_data["name"],
        'desc': dzi_data["description"],
        'img': dzi_data["image_url"]
    }
    url = WEB_APP_URL + '?' + urllib.parse.urlencode(params, safe='')

    # –û—Ç–ø—Ä–∞–≤–ª—è–µ–º —Ä–µ–∑—É–ª—å—Ç–∞—Ç
    text = f"‚ú® –¢–∞–ª–∏—Å–º–∞–Ω –¥–ª—è *{category}* –ø–æ–¥–æ–±—Ä–∞–Ω!\n\nüìø *{dzi_data['name']}*"
    markup = types.InlineKeyboardMarkup()
    markup.add(types.InlineKeyboardButton("üîÆ –û—Ç–∫—Ä—ã—Ç—å –≤ –ü–æ—Ä—Ç–∞–ª–µ", web_app=types.WebAppInfo(url=url)))
    markup.add(types.InlineKeyboardButton("‚¨ÖÔ∏è –î—Ä—É–≥–∞—è —Å—Ñ–µ—Ä–∞", callback_data='ACTION_SELECT_CATEGORY'))
    
    bot.edit_message_text(
        text, call.message.chat.id, call.message.message_id,
        parse_mode="Markdown", reply_markup=markup
    )
    bot.answer_callback_query(call.id, f"‚úÖ {category}")

@bot.callback_query_handler(func=lambda call: call.data == 'ACTION_MENU')
def go_to_menu(call):
    send_welcome(call.message)  # –ø–µ—Ä–µ–∏—Å–ø–æ–ª—å–∑—É–µ–º /start –ª–æ–≥–∏–∫—É
    bot.answer_callback_query(call.id)

# --- –ó–ê–ü–£–°–ö ---
if __name__ == '__main__':
    initialize_db()
    print("‚úÖ –ë–æ—Ç '–î–∑–∏' –∑–∞–ø—É—â–µ–Ω. –°—Ñ–µ—Ä—ã:", ', '.join(CATEGORY_OPTIONS))
    bot.infinity_polling(skip_pending=True)
